{% extends 'base.html' %}

{% block title %}Тексты - Text Corpus Management{% endblock %}

{% block content %}
<div class="section">
    <h2> Управление текстами</h2>
    <p>Создание, редактирование и управление текстами в корпусах</p>
</div>

<div class="grid">
    <div class="card">
        <h3> Создать текст</h3>
        <form onsubmit="createText(event)">
            <div class="form-group">
                <label for="text-name">Название:</label>
                <input type="text" id="text-name" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="text-description">Описание:</label>
                <textarea id="text-description" class="form-control" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label for="text-content">Текст (минимум 10 символов):</label>
                <textarea id="text-content" class="form-control" rows="5" required></textarea>
            </div>
            <div class="form-group">
                <label for="text-corpus-id">ID корпуса:</label>
                <input type="number" id="text-corpus-id" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="text-translation-id">ID перевода (опционально):</label>
                <input type="number" id="text-translation-id" class="form-control">
            </div>
            <button type="submit" class="btn btn-success">Создать текст</button>
        </form>
        <div id="create-result" class="result"></div>
    </div>
    
    <div class="card">
        <h3> Поиск текста</h3>
        <form onsubmit="searchText(event)">
            <div class="form-group">
                <label for="search-text-id">ID текста:</label>
                <input type="number" id="search-text-id" class="form-control" placeholder="Введите ID">
            </div>
            <button type="submit" class="btn btn-primary">Найти текст</button>
        </form>
        <div id="search-result" class="result"></div>
    </div>
</div>

<div class="section">
    <h2> Список текстов</h2>
    <div class="form-group">
        <label for="filter-corpus">Фильтр по корпусу:</label>
        <select id="filter-corpus" class="form-control" onchange="loadTexts()">
            <option value="">Все корпуса</option>
        </select>
    </div>
    <button onclick="loadTexts()" class="btn btn-secondary">Обновить список</button>
    <div id="texts-list">
        <p>Загрузка текстов...</p>
    </div>
</div>

<div class="section">
    <h2> Редактирование текста</h2>
    <form onsubmit="updateText(event)">
        <div class="form-group">
            <label for="update-text-id">ID текста для редактирования:</label>
            <input type="number" id="update-text-id" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="update-text-name">Новое название:</label>
            <input type="text" id="update-text-name" class="form-control">
        </div>
        <div class="form-group">
            <label for="update-text-description">Новое описание:</label>
            <textarea id="update-text-description" class="form-control" rows="2"></textarea>
        </div>
        <div class="form-group">
            <label for="update-text-content">Новый текст:</label>
            <textarea id="update-text-content" class="form-control" rows="5"></textarea>
        </div>
        <div class="form-group">
            <label for="update-text-corpus-id">Новый ID корпуса:</label>
            <input type="number" id="update-text-corpus-id" class="form-control">
        </div>
        <button type="submit" class="btn btn-primary">Обновить текст</button>
    </form>
    <div id="update-result" class="result"></div>
</div>

<div class="section">
    <h2> Удаление текста</h2>
    <form onsubmit="deleteText(event)">
        <div class="form-group">
            <label for="delete-text-id">ID текста для удаления:</label>
            <input type="number" id="delete-text-id" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-danger">Удалить текст</button>
    </form>
    <div id="delete-result" class="result"></div>
</div>

<script>
    // Загрузка данных при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        loadCorpora();
        loadTexts();
    });
    
    async function loadCorpora() {
        try {
            const result = await makeRequest('/api/corpus/');
            
            if (result.success) {
                const select = document.getElementById('filter-corpus');
                select.innerHTML = '<option value="">Все корпуса</option>';
                
                result.data.forEach(corpus => {
                    const option = document.createElement('option');
                    option.value = corpus.id;
                    option.textContent = `${corpus.name} (ID: ${corpus.id})`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Ошибка загрузки корпусов:', error);
        }
    }
    
    async function loadTexts() {
        try {
            const corpusId = document.getElementById('filter-corpus').value;
            let url = '/api/text/';
            
            if (corpusId) {
                url = `/api/text/by_corpus/?corpus_id=${corpusId}`;
            }
            
            const result = await makeRequest(url);
            
            if (result.success) {
                displayTexts(result.data);
            } else {
                document.getElementById('texts-list').innerHTML = 
                    '<p class="status offline">Ошибка загрузки текстов</p>';
            }
        } catch (error) {
            document.getElementById('texts-list').innerHTML = 
                '<p class="status offline">Ошибка: ' + error.message + '</p>';
        }
    }
    
    function displayTexts(texts) {
        const listDiv = document.getElementById('texts-list');
        
        if (texts.length === 0) {
            listDiv.innerHTML = '<p>Тексты не найдены</p>';
            return;
        }
        
        let html = '<div class="grid">';
        
        texts.forEach(text => {
            const preview = text.text.length > 100 ? 
                text.text.substring(0, 100) + '...' : text.text;
            
            html += '<div class="card">';
            html += `<h3>${text.name}</h3>`;
            html += `<p><strong>ID:</strong> ${text.id}</p>`;
            html += `<p><strong>Корпус ID:</strong> ${text.corpus_id}</p>`;
            html += `<p><strong>Описание:</strong> ${text.description || 'Не указано'}</p>`;
            html += `<p><strong>Перевод ID:</strong> ${text.has_translation_id || 'Нет'}</p>`;
            html += `<p><strong>Текст:</strong> ${preview}</p>`;
            html += `<p><strong>Создан:</strong> ${new Date(text.created_at).toLocaleString('ru-RU')}</p>`;
            html += `<button onclick="viewFullText(${text.id})" class="btn btn-primary">Просмотреть полностью</button>`;
            html += '</div>';
        });
        
        html += '</div>';
        listDiv.innerHTML = html;
    }
    
    async function createText(event) {
        event.preventDefault();
        clearResult('create-result');
        
        const data = {
            name: document.getElementById('text-name').value,
            description: document.getElementById('text-description').value,
            text: document.getElementById('text-content').value,
            corpus_id: parseInt(document.getElementById('text-corpus-id').value)
        };
        
        const translationId = document.getElementById('text-translation-id').value;
        if (translationId) {
            data.has_translation_id = parseInt(translationId);
        }
        
        try {
            const result = await makeRequest('/api/text/create/', 'POST', data);
            showResult('create-result', result, result.success);
            
            if (result.success) {
                // Очищаем форму
                document.getElementById('text-name').value = '';
                document.getElementById('text-description').value = '';
                document.getElementById('text-content').value = '';
                document.getElementById('text-corpus-id').value = '';
                document.getElementById('text-translation-id').value = '';
                // Обновляем список
                loadTexts();
            }
        } catch (error) {
            showResult('create-result', {error: error.message}, false);
        }
    }
    
    async function searchText(event) {
        event.preventDefault();
        clearResult('search-result');
        
        const id = document.getElementById('search-text-id').value;
        if (!id) {
            showResult('search-result', {error: 'Введите ID текста'}, false);
            return;
        }
        
        try {
            const result = await makeRequest(`/api/text/get/?id=${id}`);
            showResult('search-result', result, result.success);
        } catch (error) {
            showResult('search-result', {error: error.message}, false);
        }
    }
    
    async function updateText(event) {
        event.preventDefault();
        clearResult('update-result');
        
        const id = document.getElementById('update-text-id').value;
        const data = {};
        
        const name = document.getElementById('update-text-name').value;
        const description = document.getElementById('update-text-description').value;
        const text = document.getElementById('update-text-content').value;
        const corpusId = document.getElementById('update-text-corpus-id').value;
        
        if (name) data.name = name;
        if (description) data.description = description;
        if (text) data.text = text;
        if (corpusId) data.corpus_id = parseInt(corpusId);
        
        if (Object.keys(data).length === 0) {
            showResult('update-result', {error: 'Заполните хотя бы одно поле для обновления'}, false);
            return;
        }
        
        try {
            const result = await makeRequest(`/api/text/update/?id=${id}`, 'PUT', data);
            showResult('update-result', result, result.success);
            
            if (result.success) {
                loadTexts();
            }
        } catch (error) {
            showResult('update-result', {error: error.message}, false);
        }
    }
    
    async function deleteText(event) {
        event.preventDefault();
        clearResult('delete-result');
        
        const id = document.getElementById('delete-text-id').value;
        
        if (!confirm(`Вы уверены, что хотите удалить текст с ID ${id}?`)) {
            return;
        }
        
        try {
            const result = await makeRequest(`/api/text/delete/?id=${id}`, 'DELETE');
            showResult('delete-result', result, result.success);
            
            if (result.success) {
                loadTexts();
            }
        } catch (error) {
            showResult('delete-result', {error: error.message}, false);
        }
    }
    
    async function viewFullText(textId) {
        try {
            const result = await makeRequest(`/api/text/get/?id=${textId}`);
            
            if (result.success) {
                const text = result.data;
                let html = `<h3>${text.name}</h3>`;
                html += `<p><strong>ID:</strong> ${text.id}</p>`;
                html += `<p><strong>Корпус ID:</strong> ${text.corpus_id}</p>`;
                html += `<p><strong>Описание:</strong> ${text.description || 'Не указано'}</p>`;
                html += `<p><strong>Перевод ID:</strong> ${text.has_translation_id || 'Нет'}</p>`;
                html += `<p><strong>Полный текст:</strong></p>`;
                html += `<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; white-space: pre-wrap;">${text.text}</div>`;
                html += `<p><strong>Создан:</strong> ${new Date(text.created_at).toLocaleString('ru-RU')}</p>`;
                
                showResult('search-result', {text: html}, true);
            } else {
                showResult('search-result', result, false);
            }
        } catch (error) {
            showResult('search-result', {error: error.message}, false);
        }
    }
</script>
{% endblock %}
